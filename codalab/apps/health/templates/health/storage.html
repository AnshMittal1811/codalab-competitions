{% extends "base.html" %}

{% load humanize %}
{% load codalab_tags %}

{% block head_title %}Storage Analytics{% endblock head_title %}
{% block page_title %}Storage Analytics{% endblock page_title %}


{% block extra_headers %}
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    {% verbatim %}
        <div id="storage-total-app">
            <div style="display: flex; flex-direction: row">
                <h4>Total Storage Usage</h4>
                <h4 style="margin-left: auto">updated {{ storage_analytics_data_date | prettyDate }}</h4>
            </div>
            <v-data-table
                :headers="headers"
                :items="storage_analytics_data"
                hide-default-header
                hide-default-footer
                class="elevation-1"
                :loading="loading"
                loading-text="Loading... Please wait"
            >
                <template v-slot:item.size="{ item }">
                    <span>{{ item.size | prettyBytes }}</span>
                </template>
            </v-data-table>
        </div>
        <!--
        <div id="storage-timeline-app">
            <v-app id="inspire">
                <v-card
                        class="mx-auto text-xs-center"
                        color="blue"
                        dark
                        max-width="1400"
                        :loading="loading"
                >
                    <template slot="progress">
                        <v-progress-linear
                                color="deep-purple"
                                height="20"
                                indeterminate
                        ></v-progress-linear>
                    </template>
                    <v-card-text>
                        <div class="display-1 font-weight-thin">Storage use over time</div>
                    </v-card-text>
                    <v-card-text>
                        <v-sheet color="rgba(0, 0, 0, .12)" height="400" width="1100">
                            <v-sparkline
                                    label-size="14"
                                    :labels="storage_labels"
                                    :value="storage_totals"
                                    color="rgba(255, 255, 255, .7)"
                                    height="300"
                                    width="1000"
                                    padding="96"
                                    stroke-linecap="round"
                                    smooth
                            >
                                <template
                                        slot="label"
                                        slot-scope="item"
                                >
                                    {{ item.value }}: {{ storage_totals[item.index] }}
                                </template>
                            </v-sparkline>
                        </v-sheet>
                    </v-card-text>
                </v-card>
                <template>
                    <v-container fluid>
                        <v-row align="center">
                            <v-col cols="3">
                                <v-subheader>
                                    Units
                                </v-subheader>
                            </v-col>

                            <v-col cols="3">
                                <v-select
                                        v-model="select"
                                        :hint="`${select.value}`"
                                        :items="unit_selections"
                                        :loading="loading"
                                        item-text="unit"
                                        item-value="value"
                                        label="Select"
                                        @change="set_unit(select.value)"
                                        persistent-hint
                                        return-object
                                        single-line
                                ></v-select>
                            </v-col>
                            <v-col cols="3">
                                <v-subheader>
                                    Date Range (Sample points)
                                </v-subheader>
                            </v-col>

                            <v-col cols="3">
                                <v-slider
                                        v-model="date_range.val"
                                        max="45"
                                        min="2"
                                        :loading="loading"
                                        :color="date_range.color"
                                        :label="`${date_range.val}`"
                                        @end="set_date_range(date_range.val)"
                                ></v-slider>
                            </v-col>
                        </v-row>
                    </v-container>
                </template>
            </v-app>
        </div>
        -->
        <h4>Competition Storage Analytics</h4>
        <div id="storage-competitions-app">
            <v-data-table
                    :headers="headers"
                    :items="comp_list"
                    :items-per-page="50"
                    :footer-props="footer_properties"
                    :loading="loading"
                    multi-sort
            >
            </v-data-table>
        </div>
        <h4>User Storage Analytics</h4>
        <i>Note: User competition usage will include all above analytics for competitions. (Including user's own
            submissions). Dataset usage represents those not tied to a competition, and Submission usage represent those
            not in the user's own competition.</i>
        <!--
        <div id="storage-users-app">
            <v-data-table
                    :headers="headers"
                    :items="user_list"
                    :items-per-page="25"
                    :footer-props="footer_properties"
                    :loading="loading"
                    multi-sort
            >
            </v-data-table>
        </div>
        -->
    {% endverbatim %}
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/2.3.0-beta.6/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.js"></script>
    <script>
        $(document).ready(function () {
            new Vue({
                el: '#storage-total-app',
                vuetify: new Vuetify(),
                data: function () {
                    return {
                        loading: true,
                        storage_analytics_data: [],
                        storage_analytics_data_date: "",
                        headers: [
                            {text: 'Stat', value: 'stat'},
                            {text: 'Size (bytes)', value: 'size'},
                        ],
                        footer_properties: {
                            'items-per-page-options': [25, 50, 100, -1],
                        }
                    }
                },
                computed: {},
                mounted: function () {
                    this.get_storage_analytics()
                },
                methods: {
                    get_storage_analytics() {
                        fetch("/api/storage/get_total_analytics")
                        .then(response => {
                            return response.json()
                        })
                        .then(json => {
                            this.storage_analytics_data = [
                                {
                                    'stat': "Total usage",
                                    'size': json.total_use
                                },
                                {
                                    'stat': "Competition usage",
                                    'size': json.competition_use
                                },
                                {
                                    'stat': "Submission usage",
                                    'size': json.submission_use
                                },
                                {
                                    'stat': "Dataset usage",
                                    'size': json.dataset_use
                                },
                                {
                                    'stat': "Bundle usage",
                                    'size': json.bundle_use
                                },
                                {
                                    'stat': "Dumps usage",
                                    'size': json.dumps_use
                                }
                            ];
                            this.storage_analytics_data_date = json.created_at;
                        })
                        .catch(error => {
                            console.log("error in get_storage_analytics", error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    }                    
                },
                filters: {
                    prettyBytes: function(bytes, decimals, kib, maxunit) {
                        kib = kib || false
                        if (bytes === 0) return '0 Bytes'
                        if (isNaN(parseFloat(bytes)) && !isFinite(bytes)) return ''
                        const k = kib ? 1024 : 1000
                        const dm = decimals != null && !isNaN(decimals) && decimals >= 0 ? decimals : 2
                        const sizes = kib ? ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB', 'BiB'] : ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB', 'BB']
                        var i = Math.floor(Math.log(bytes) / Math.log(k))
                        if (maxunit != undefined) {
                            const index = sizes.indexOf(maxunit)
                            if (index != -1) i = index
                        }
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]
                    },
                    prettyDate: function(date) {
                        return moment(date).calendar();
                    }
                }
            })
            new Vue({
                el: '#storage-competitions-app',
                vuetify: new Vuetify(),
                data: function () {
                    return {
                        loading: true,
                        comp_list: [],
                        headers: [
                            {text: 'ID', value: 'id'},
                            {text: 'Title', value: 'title'},
                            {text: 'Creator', value: 'creator'},
                            {text: 'Is Active', value: 'is_active'},
                            {text: 'Dataset Usage (bytes)', value: 'datasets'},
                            {text: 'Submission Usage (bytes)', value: 'submissions'},
                            {text: 'Bundle Usage (bytes)', value: 'bundle'},
                            {text: 'Dumps Usage (bytes)', value: 'dumps'},
                            {text: 'Total Usage (bytes)', value: 'total'},
                        ],
                        footer_properties: {
                            'items-per-page-options': [25, 50, 100, -1],
                        },
                    }
                },
                computed: {},
                mounted: function () {
                    this.get_comp_storage_analytics();
                },
                methods: {
                    get_comp_storage_analytics() {
                        fetch("/api/storage/get_competition_analytics")
                        .then(response => {
                            return response.json();
                        })
                        .then(json => {
                            console.log(json);
                            this.comp_list = json;
                        })
                        .catch(error => {
                            console.log("error in get_comp_storage_analytics", error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    }
                }
            })
            /*
            new Vue({
                el: '#storage-users-app',
                vuetify: new Vuetify(),
                data: function () {
                    return {
                        loading: true,
                        user_list: [],
                        headers: [
                            {text: 'ID', value: 'id'},
                            {text: 'Username', value: 'username'},
                            {text: 'Email', value: 'email'},
                            {text: 'Competitions Usage (bytes)', value: 'competitions_total'},
                            {text: 'Dataset Usage (bytes)', value: 'datasets_total'},
                            {text: 'Submission Usage (bytes)', value: 'submissions_total'},
                            {text: 'Total Usage (bytes)', value: 'total'},
                        ],
                        footer_properties: {
                            'items-per-page-options': [25, 50, 100, -1],
                        },
                    }
                },
                computed: {},
                mounted: function () {
                    this.get_user_storage_analytics()
                },
                methods: {
                    get_user_storage_analytics() {
                        fetch("/api/storage/get_user_analytics")
                        .then(response => {
                            return response.json()
                        })
                        .then(json => {
                            this.user_list = json;
                        })
                        .catch(error => {
                            console.log("error in get_user_storage_analytics", error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    }
                }
            })
            */
            /*
            new Vue({
                el: '#storage-timeline-app',
                vuetify: new Vuetify(),
                data: function () {
                    return {
                        loading: true,
                        unit: 'years',
                        sample_points: 5,
                        data_list: [],
                        storage_totals: [],
                        storage_labels: [],
                        // Sparkline
                        width: 2,
                        radius: 10,
                        padding: 8,
                        lineCap: 'round',
                        fill: false,
                        type: 'trend',
                        autoLineWidth: false,
                        // Inputs
                        select: {unit: 'Years', value: 'years'},
                        unit_selections: [
                            {unit: 'Hours', value: 'hours'},
                            {unit: 'Days', value: 'days'},
                            {unit: 'Weeks', value: 'weeks'},
                            {unit: 'Months', value: 'months'},
                            {unit: 'Years', value: 'years'},
                        ],
                        date_range: { label: 'Date Range', val: 5, color: 'orange darken-3' },
                    }
                },
                computed: {},
                mounted: function () {
                    this.get_storage_timeline_analytics()
                },
                methods: {
                    get_storage_timeline_analytics() {
                        this.loading = true;
                        fetch(`/api/storage/get_analytics_overtime?unit=${this.unit}&sample_points=${this.sample_points}`)
                        .then(response => {
                            return response.json()
                        })
                        .then(json => {
                            this.data_list = json;
                            var storage_totals = [];
                            var storage_labels = [];
                            $.each(this.data_list, function (index, data_point) {
                                // Should have a dict/obj here
                                $.each(data_point, function (date, total) {
                                    storage_totals.push(total)
                                    storage_labels.push(date)
                                });
                            });
                            this.storage_totals = storage_totals;
                            this.storage_labels = storage_labels;
                        })
                        .catch(error => {
                            console.log("error in get_storage_timeline_analytics", error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                    },
                    set_date_range(value) {
                        this.sample_points = value;
                        this.get_storage_timeline_analytics();
                    },
                    set_unit(value) {
                        this.unit = value;
                        this.get_storage_timeline_analytics();
                    },
                }
            })
            */
        })
    </script>
{% endblock %}
